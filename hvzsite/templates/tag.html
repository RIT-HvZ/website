{% extends 'base.html' %}
{% load static %}
{% block title %} HvZ @ RIT - Register Tag {% endblock %}
{% block extrahead %}
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
<script>
    $(document).ready(function () {
        $("#id_tagger_id").attr('size',36);
        $("#id_taggee_id").attr('size',36);
    });
    </script>
{% endblock %}
{% block body %}
<div id="qr-reader-holder"><div id="qr-reader"></div></div>
<script>
var html5QrCode = new Html5Qrcode("qr-reader");
const stop = () => {
    html5QrCode.stop().then((ignore) => {}).catch((err) => {});
}
const fillZombie = (decodedText, decodedResult) => {
    document.getElementById("id_tagger_id").value = decodedText;
    stop();
};
const fillHuman = (decodedText, decodedResult) => {
    document.getElementById("id_taggee_id").value = decodedText;
    stop();
};
const config = { fps: 10, qrbox: { width: 350, height: 350 } };
function humanstop() {
    stop();
    document.getElementById('human_qr').innerHTML = "QR";
    document.getElementById('human_qr').onclick = launch_human_qr;
}
function zombiestop() {
    stop();
    document.getElementById('zombie_qr').innerHTML = "QR";
    document.getElementById('zombie_qr').onclick = launch_zombie_qr;
}
function launch_zombie_qr() {
    html5QrCode.start({ facingMode: "environment" }, config, fillZombie);
    document.getElementById('zombie_qr').innerHTML = "Stop";
    document.getElementById('zombie_qr').onclick = zombiestop;
}
function launch_human_qr() {      
    html5QrCode.start({ facingMode: "environment" }, config, fillHuman);
    document.getElementById('human_qr').innerHTML = "Stop";
    document.getElementById('human_qr').onclick = humanstop;
}
</script>
<div class="row">
    <div class="col">
        <h1 class="center"> Register Tag </h1>
    </div>
</div>
<div class="row">
    <div class="col">
        {% if tagcomplete %}
            <h2 class="tagnotification">Successfully registered Tag of {% if tag.taggee %}{{tag.taggee}}{% else %}Body Armor{% endif %} by {{tag.tagger}}!</h2>
        {% endif %}
        
        <form method="post" id="tagform" class="center">{% csrf_token %}
            {% if form.non_field_errors|length > 0 %}<div class="tagformerrors mb-3">{{ form.non_field_errors }}</div>{% endif %}
            <div class="mb-3">
                {{ form.tagger_id.errors }}
                <label for="{{ form.tagger_id.id_for_label }}" class="form-label">Tagger (Zombie) ID</label>
                {{ form.tagger_id }}
                <button id="zombie_qr" type="button" class="qrlaunch" onclick="launch_zombie_qr()">QR</button>
            </div>
            <div class="mb-3">
                {{ form.taggee_id.errors }}
                <label for="{{ form.taggee_id.id_for_label }}" class="form-label">Taggee (Human) ID / Body Armor ID</label>
                {{ form.taggee_id }}
                <button id="human_qr" type="button" class="qrlaunch" onclick="launch_human_qr()">QR</button>
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
        </form>
    </div>
</div>
{% if qr %}
<div class="row">
    <div class="col center">
        <h1>Tag QR Code</h1>
        <h5>Have the other party scan this QR code to quickly fill both fields above</h5>
        <div class="qrcontainer center">
            <span id="qr_url">{{qr}}</span>
            <canvas id="qrcode"></canvas>
            <script type="text/javascript">
                var qrcode = new QRious({
                    element: document.getElementById("qrcode"),
                    background: '#000000',
                    backgroundAlpha: 0,
                    foreground: '#00aa00',
                    foregroundAlpha: 1,
                    level: 'L',
                    padding: 10,
                    size: 400,
                    value: document.getElementById('qr_url').innerText
                });
                $('#qrcode > img').css({'margin':'auto'});
            </script>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}